---
title: Echo
order: 1
---

# Echo

ä½œè€…: [@wangenius](https://github.com/wangenius)

> ç›®å‰æš‚æœªå¼€æ”¾

Echo æ˜¯ä¸€ä¸ªåŸºäº Zustand çš„è½»é‡çº§çŠ¶æ€ç®¡ç†å·¥å…·,ä¸“æ³¨äºæä¾›ç®€å•ä¸”å¼ºå¤§çš„çŠ¶æ€ç®¡ç†è§£å†³æ–¹æ¡ˆã€‚

åŸºäº Echo çš„ç‰¹æ€§,å¯ä»¥è½»æ¾å®ç°çŠ¶æ€ç®¡ç†,æ•°æ®æŒä¹…åŒ–,å“åº”å¼æ›´æ–°ç­‰åŠŸèƒ½ã€‚

è½»æ¾å°è£…è·¯ç”±,è¡¨å•,æ•°æ®è¯·æ±‚ç­‰æ“ä½œã€‚

## ç›®å½•

- [ç‰¹æ€§](#ç‰¹æ€§)
- [å®‰è£…](#å®‰è£…)
- [åŸºç¡€ä½¿ç”¨](#åŸºç¡€ä½¿ç”¨)
- [é«˜çº§ç‰¹æ€§](#é«˜çº§ç‰¹æ€§)
- [API å‚è€ƒ](#api-å‚è€ƒ)
- [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)

## ç‰¹æ€§

- ğŸš€ è½»é‡çº§,ä½“ç§¯å°å·§
- ğŸ’¾ å†…ç½®æŒä¹…åŒ–æ”¯æŒ(localStorage/indexedDB)
- ğŸ¯ æ”¯æŒ React Hooks å’Œå‘½ä»¤å¼è°ƒç”¨
- ğŸ”„ å“åº”å¼æ›´æ–°
- ğŸ›  å®Œæ•´çš„ TypeScript æ”¯æŒ
- ğŸ“¦ æ¨¡å—åŒ–è®¾è®¡
- ğŸ” æ·±åº¦çŠ¶æ€æ¯”è¾ƒ
- âš¡ æ‰¹é‡æ›´æ–°æ”¯æŒ
- ğŸ›¡ï¸ é”™è¯¯æ¢å¤æœºåˆ¶

## å®‰è£…

```bash
npm install @your-org/echo
# æˆ–
yarn add @your-org/echo
```

## åŸºç¡€ä½¿ç”¨

### åˆ›å»º Store

```typescript
interface UserStore {
  name: string;
  age: number;
  settings: {
    theme: 'light' | 'dark';
  };
}

const echo = new Echo<UserStore>(
  'user',
  {
    name: '',
    age: 0,
    settings: {
      theme: 'light',
    },
  },
  {
    methods: {
      incrementAge: state => ({ age: state.age + 1 }),
      updateTheme: state => ({
        settings: { ...state.settings, theme: 'dark' },
      }),
    },
    storage: 'localStorage', // æˆ– 'indexedDB'
  }
);
```

### åœ¨ React ç»„ä»¶ä¸­ä½¿ç”¨

```typescript
function UserProfile() {
  // è·å–å•ä¸ªçŠ¶æ€
  const name = echo.use(state => state.name);

  // è·å–å¤šä¸ªçŠ¶æ€å’Œæ–¹æ³•
  const { age, settings, incrementAge } = echo.use(state => ({
    age: state.age,
    settings: state.settings,
    incrementAge: state.incrementAge
  }));

  // ä½¿ç”¨å†…ç½®æ–¹æ³•
  const { set, remove, clear } = echo.use();

  return (
    <div>
      <h2>{name}</h2>
      <p>Age: {age}</p>
      <p>Theme: {settings.theme}</p>
      <button onClick={incrementAge}>Add Age</button>
      <button onClick={() => set({ name: 'John' })}>Set Name</button>
    </div>
  );
}
```

### å‘½ä»¤å¼è°ƒç”¨

```typescript
// è·å–çŠ¶æ€å¿«ç…§
const currentState = echo.snapshot;

// ä½¿ç”¨ set æ–¹æ³•æ›´æ–°çŠ¶æ€
echo.set({ name: 'John' }); // é»˜è®¤æµ…åˆå¹¶
echo.set({ settings: { theme: 'dark' } }, 'deep'); // æ·±åº¦åˆå¹¶
echo.set(state => ({ age: state.age + 1 })); // å‡½æ•°å¼æ›´æ–°

// ä½¿ç”¨è‡ªå®šä¹‰æ–¹æ³•
const { incrementAge } = echo.beats;
incrementAge();

// è®¢é˜…çŠ¶æ€å˜åŒ–
const unsubscribe = echo.subscribe(
  state => state.name,
  (newName, prevName) => console.log('name changed:', prevName, '->', newName)
);
```

## é«˜çº§ç‰¹æ€§

### çŠ¶æ€æ›´æ–°æ¨¡å¼

Echo æä¾›ä¸‰ç§çŠ¶æ€æ›´æ–°æ¨¡å¼:

```typescript
// 1. æµ…åˆå¹¶æ¨¡å¼(é»˜è®¤)
echo.set({ name: 'John' });

// 2. æ·±åº¦åˆå¹¶æ¨¡å¼
echo.set(
  {
    settings: {
      theme: 'dark', // åªæ›´æ–° theme,ä¿ç•™å…¶ä»–è®¾ç½®
    },
  },
  'deep'
);

// 3. å®Œå…¨æ›¿æ¢æ¨¡å¼
echo.set({ name: 'John', age: 25 }, 'replace');
```

### æ‰¹é‡æ›´æ–°

```typescript
echo.workflow([
  { name: 'John' },
  state => ({ age: state.age + 1 }),
  { settings: { theme: 'dark' } },
]);
```

### é”™è¯¯å¤„ç†

```typescript
// è®¾ç½®é”™è¯¯å¤„ç†å™¨
echo.setErrorHandler(error => {
  console.error('Store operation failed:', error);
  // æ‰§è¡Œé”™è¯¯æ¢å¤é€»è¾‘
});

// ä½¿ç”¨ try-catch æ•è·é”™è¯¯
try {
  echo.set({ invalidValue: null });
} catch (error) {
  console.error('Update failed:', error);
}
```

### çŠ¶æ€æ¯”è¾ƒ

```typescript
// ä½¿ç”¨ equals è¿›è¡ŒçŠ¶æ€æ¯”è¾ƒ
const isAdult = echo.equals(state => state.age >= 18, true);
const isDarkTheme = echo.equals(state => state.settings.theme === 'dark', true);
```

## API å‚è€ƒ

### Echo ç±»

```typescript
class Echo<T extends Record<string, any>, AllowNull = undefined> {
  // å±æ€§
  readonly snapshot: AllowNull extends null ? T | null : T;
  readonly beats: { [K in keyof Methods]: () => ReturnType<Methods[K]> };

  // æ„é€ å‡½æ•°
  constructor(
    name: string,
    defaultValue: AllowNull extends null ? T | null : T,
    options?: {
      storage?: 'localStorage' | 'indexedDB';
      persist?: boolean;
      methods?: Record<string, (state: T) => Partial<T>>;
    }
  );

  // æ ¸å¿ƒæ–¹æ³•
  set(
    value: Partial<T> | ((state: T) => Partial<T>),
    mode?: 'merge' | 'replace' | 'deep'
  ): void;

  remove(key: keyof T): void;
  clear(): void;
  toDefault(): void;

  // Hook æ–¹æ³•
  use<S>(selector?: (state: T & Methods) => S): S;

  // è®¢é˜…æ–¹æ³•
  subscribe<U>(
    selector: (state: T) => U,
    listener: (newState: U, prevState?: U) => void
  ): () => void;

  // å·¥å…·æ–¹æ³•
  equals<S>(selector: (state: T) => S, value: S): boolean;
  workflow(updates: Array<Partial<T> | ((state: T) => Partial<T>)>): void;
  resetKey<K extends keyof T>(key: K): void;
  setErrorHandler(handler: (error: any) => void): void;
}
```

### çŠ¶æ€æ›´æ–°æ¨¡å¼

```typescript
type UpdateMode = 'merge' | 'replace' | 'deep';
```

### å­˜å‚¨ç±»å‹

```typescript
type StorageType = 'localStorage' | 'indexedDB';
```

## æœ€ä½³å®è·µ

### çŠ¶æ€è®¾è®¡

```typescript
// 1. ä½¿ç”¨æ¥å£å®šä¹‰çŠ¶æ€ç»“æ„
interface AppState {
  user: {
    id: string;
    name: string;
    preferences: {
      theme: 'light' | 'dark';
      language: string;
    };
  };
  settings: {
    notifications: boolean;
    autoSave: boolean;
  };
}

// 2. åˆ†ç¦»çŠ¶æ€å’Œæ–¹æ³•
const methods = {
  updateTheme: (state: AppState) => ({
    user: {
      ...state.user,
      preferences: {
        ...state.user.preferences,
        theme: state.user.preferences.theme === 'light' ? 'dark' : 'light',
      },
    },
  }),
  toggleNotifications: (state: AppState) => ({
    settings: {
      ...state.settings,
      notifications: !state.settings.notifications,
    },
  }),
};

// 3. åˆ›å»º store
const appStore = new Echo<AppState>('app', initialState, { methods });
```

### æ€§èƒ½ä¼˜åŒ–

```typescript
// 1. ä½¿ç”¨ç»†ç²’åº¦çš„é€‰æ‹©å™¨
const userName = echo.use(state => state.user.name); // æ¨è
const user = echo.use(state => state.user); // ä¸æ¨è

// 2. ä½¿ç”¨ equals è¿›è¡ŒçŠ¶æ€æ¯”è¾ƒ
if (echo.equals(state => state.settings.theme, 'dark')) {
  // æ‰§è¡Œç›¸å…³é€»è¾‘
}

// 3. æ‰¹é‡æ›´æ–°é¿å…å¤šæ¬¡æ¸²æŸ“
echo.workflow([
  { name: 'John' },
  state => ({ age: state.age + 1 }),
  { theme: 'dark' },
]);
```

### é”™è¯¯å¤„ç†

```typescript
// 1. è®¾ç½®å…¨å±€é”™è¯¯å¤„ç†å™¨
echo.setErrorHandler(error => {
  console.error('Store error:', error);
  // å¯ä»¥è§¦å‘å…¨å±€æç¤ºæˆ–æ‰§è¡Œå›æ»šæ“ä½œ
});

// 2. ä½¿ç”¨ try-catch å¤„ç†ç‰¹å®šæ“ä½œ
try {
  echo.workflow([
    { name: 'John' },
    state => {
      if (state.age < 0) throw new Error('Invalid age');
      return { age: state.age + 1 };
    },
  ]);
} catch (error) {
  // å¤„ç†ç‰¹å®šé”™è¯¯
}
```

### TypeScript æ”¯æŒ

```typescript
// å®Œæ•´çš„ç±»å‹æ¨å¯¼
interface UserState {
  name: string;
  age: number;
  settings: {
    theme: 'light' | 'dark';
  };
}

const echo = new Echo<UserState>('user', {
  name: '',
  age: 0,
  settings: { theme: 'light' },
});

// TypeScript ä¼šæä¾›å®Œæ•´çš„ç±»å‹æ£€æŸ¥å’Œè‡ªåŠ¨è¡¥å…¨
echo.use(state => state.settings.theme); // ç±»å‹å®‰å…¨
echo.set({ theme: 'invalid' }); // TS é”™è¯¯
```

## è¡¥å……è¯´æ˜

### æ„é€ å‡½æ•°è¯¦è§£

```typescript
constructor(
  name: string,          // store å”¯ä¸€æ ‡è¯†å
  defaultValue: T,       // åˆå§‹çŠ¶æ€å€¼
  options?: {
    storage?: 'localStorage' | 'indexedDB', // å­˜å‚¨ç±»å‹
    persist?: boolean,   // æ˜¯å¦å¯ç”¨æŒä¹…åŒ–(é»˜è®¤true)
    methods?: StoreMethods<T> // è‡ªå®šä¹‰æ–¹æ³•
  }
)
```

æ„é€ å‡½æ•°ä¼šè¿›è¡Œä»¥ä¸‹éªŒè¯:

- name å¿…é¡»æ˜¯éç©ºå­—ç¬¦ä¸²
- defaultValue å¿…é¡»æ˜¯å¯¹è±¡æˆ– null(å½“ AllowNull=true)
- å¦‚æœéªŒè¯å¤±è´¥ä¼šæŠ›å‡ºé”™è¯¯

### çŠ¶æ€æ›´æ–°æœºåˆ¶è¯¦è§£

Echo å†…éƒ¨ä½¿ç”¨äº† Zustand ä½œä¸ºçŠ¶æ€ç®¡ç†æ ¸å¿ƒ,å¹¶åœ¨æ­¤ï¿½ï¿½ï¿½ç¡€ä¸Šæ‰©å±•äº†æ›´å¤šç‰¹æ€§:

1. çŠ¶æ€éªŒè¯

```typescript
private validateState(value: Partial<T>): void {
  if (value !== null && typeof value !== 'object') {
    throw new Error('State must be an object or null');
  }
}
```

2. å®‰å…¨çš„çŠ¶æ€æ›´æ–°

```typescript
const safeSet = (fn: Function) => {
  try {
    fn();
  } catch (error) {
    console.error(`Store operation failed:`, error);
    set(this.defaultValue);
    this.onError?.(error);
  }
};
```

3. æ·±åº¦æ¯”è¾ƒå®ç°

```typescript
private isEqual(a: any, b: any): boolean {
  if (a === b) return true;
  if (!a || !b || typeof a !== 'object' || typeof b !== 'object') {
    return false;
  }
  const keysA = Object.keys(a);
  const keysB = Object.keys(b);
  if (keysA.length !== keysB.length) return false;
  return keysA.every(key => this.isEqual(a[key], b[key]));
}
```

### æŒä¹…åŒ–å­˜å‚¨è¯¦è§£

Echo çš„æŒä¹…åŒ–å­˜å‚¨åŸºäº Zustand/middleware å®ç°:

```typescript
persist(createStoreImpl, {
  name: this.name,
  storage: createJSONStorage(() =>
    this.storageType === 'localStorage' ? localStorage : localforage
  ),
  onRehydrateStorage: () => state => {
    if (state) {
      console.log(`Store ${this.name} rehydrated`);
    }
  },
});
```

ç‰¹ç‚¹:

1. è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
2. æ”¯æŒå­˜å‚¨ç±»å‹åˆ‡æ¢
3. æä¾›é‡æ°´åŒ–å›è°ƒ
4. é”™è¯¯è‡ªåŠ¨æ¢å¤

### çŠ¶æ€è®¢é˜…å¢å¼º

subscribe æ–¹æ³•æ”¯æŒå‰ä¸€ä¸ªçŠ¶æ€å€¼:

```typescript
subscribe<U>(
  selector: (state: T) => U,
  listener: (newState: U, prevState?: U) => void
): () => void
```

ä½¿ç”¨åœºæ™¯:

1. çŠ¶æ€å˜åŒ–æ—¥å¿—

```typescript
echo.subscribe(
  state => state,
  (newState, prevState) => {
    console.log('State changed:', {
      from: prevState,
      to: newState,
      diff: getDiff(prevState, newState),
    });
  }
);
```

2. æ¡ä»¶åŠ¨ä½œè§¦å‘

```typescript
echo.subscribe(
  state => state.settings.theme,
  (newTheme, prevTheme) => {
    if (newTheme !== prevTheme) {
      updateSystemTheme(newTheme);
    }
  }
);
```

### å·¥ä½œæµæ‰¹å¤„ç†è¯¦è§£

workflow æ–¹æ³•çš„å®ç°ç»†èŠ‚:

```typescript
workflow(
  updates: Array<Partial<T> | ((state: T) => Partial<T>)>
) {
  try {
    const state = this.snapshot;
    const batchedUpdates = updates.reduce<Partial<T>>((acc, update) => {
      const nextUpdate = typeof update === 'function'
        ? update(state)
        : update;

      if (nextUpdate !== null && typeof nextUpdate !== 'object') {
        throw new Error('Invalid update in workflow');
      }

      return {
        ...acc,
        ...nextUpdate
      };
    }, {});

    this.store.getState().set(batchedUpdates);
  } catch (error) {
    console.error('Workflow execution failed:', error);
    this.onError?.(error);
  }
}
```

ä½¿ç”¨åœºæ™¯:

1. è¡¨å•æäº¤

```typescript
echo.workflow([
  { loading: true },
  async state => {
    const result = await submitForm(state.form);
    return { submitResult: result };
  },
  { loading: false },
]);
```

2. å¤šæ­¥éª¤æ“ä½œ

```typescript
echo.workflow([
  // æ­¥éª¤1: æ›´æ–°ç”¨æˆ·ä¿¡æ¯
  { user: { name: 'John', age: 25 } },

  // æ­¥éª¤2: æ›´æ–°è®¾ç½®
  state => ({
    settings: {
      ...state.settings,
      theme: 'dark',
    },
  }),

  // æ­¥éª¤3: æ¸…ç†ä¸´æ—¶æ•°æ®
  state => {
    const { temporary, ...rest } = state;
    return rest;
  },
]);
```

### æ€§èƒ½ä¼˜åŒ–å»ºè®®è¡¥å……

1. é€‰æ‹©å™¨ä¼˜åŒ–

```typescript
// é¿å…åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶åˆ›å»ºæ–°çš„é€‰æ‹©å™¨å‡½æ•°
const selectUserName = state => state.user.name;
const selectUserAge = state => state.user.age;

function UserProfile() {
  const name = echo.use(selectUserName);
  const age = echo.use(selectUserAge);
  // ...
}
```

2. çŠ¶æ€åˆ†å‰²

```typescript
// é¿å…å¤§å‹çŠ¶æ€å¯¹è±¡
const userStore = new Echo<UserState>('user', {...});
const settingsStore = new Echo<SettingsState>('settings', {...});
const tempStore = new Echo<TempState>('temp', {...});
```

3. åˆç†ä½¿ç”¨ workflow

```typescript
// å¥½çš„åšæ³•
echo.workflow([{ loading: true }, { data: newData }, { loading: false }]);

// é¿å…
echo.set({ loading: true });
echo.set({ data: newData });
echo.set({ loading: false });
```

### å®Œæ•´çš„é”™è¯¯å¤„ç†ç¤ºä¾‹

```typescript
const echo = new Echo<AppState>('app', initialState, {
  methods: {
    riskyOperation: state => {
      if (!state.user) {
        throw new Error('User not found');
      }
      return {
        user: {
          ...state.user,
          lastOperation: Date.now(),
        },
      };
    },
  },
});

// å…¨å±€é”™è¯¯å¤„ç†
echo.setErrorHandler(error => {
  console.error('Store error:', error);
  notification.error({
    message: 'Operation Failed',
    description: error.message,
  });
});

// ç‰¹å®šæ“ä½œé”™è¯¯å¤„ç†
try {
  echo.workflow([
    { loading: true },
    state => {
      if (!state.user.permissions.includes('admin')) {
        throw new Error('Permission denied');
      }
      return { adminOperation: true };
    },
    { loading: false },
  ]);
} catch (error) {
  // å¤„ç†ç‰¹å®šé”™è¯¯
  handleSpecificError(error);
} finally {
  // ç¡®ä¿ loading çŠ¶æ€è¢«é‡ç½®
  echo.set({ loading: false });
}
```

### AllowNull ç±»å‹æ”¯æŒ

Echo æ”¯æŒé€šè¿‡æ³›å‹å‚æ•° AllowNull æ¥æ§åˆ¶çŠ¶æ€æ˜¯å¦å…è®¸ä¸º null:

```typescript
// 1. åŸºç¡€ç”¨æ³•
interface UserState {
  name: string;
  age: number;
  settings: {
    theme: 'light' | 'dark';
  };
}

// å…è®¸çŠ¶æ€ä¸º null
const nullableStore = new Echo<UserState, null>(
  'nullable-user',
  null, // åˆå§‹å€¼å¯ä»¥ä¸º null
  {
    methods: {
      clearAll: () => null, // æ–¹æ³•å¯ä»¥è¿”å› null
      initialize: () => ({
        name: '',
        age: 0,
        settings: { theme: 'light' },
      }),
    },
  }
);

// ä¸å…è®¸çŠ¶æ€ä¸º null (é»˜è®¤)
const normalStore = new Echo<UserState>('normal-user', {
  name: '',
  age: 0,
  settings: { theme: 'light' },
});
```

2. å®Œæ•´ç¤ºä¾‹:

```typescript
interface SessionState {
  user: {
    id: string;
    name: string;
  };
  token: string;
  lastActive: number;
}

// åˆ›å»ºå¯ç©ºä¼šè¯å­˜å‚¨
const sessionStore = new Echo<SessionState, null>(
  'session',
  null, // åˆå§‹ä¸º null è¡¨ç¤ºæœªç™»å½•
  {
    storage: 'localStorage',
    methods: {
      // ç™»å½•
      login: (_, userData: SessionState) => userData,

      // ç™»å‡º
      logout: () => null,

      // æ›´æ–°æœ€åæ´»åŠ¨æ—¶é—´
      updateActivity: state => {
        if (!state) return null;
        return {
          ...state,
          lastActive: Date.now()
        };
      }
    }
  }
);

// ä½¿ç”¨ç¤ºä¾‹
function App() {
  // è·å–ä¼šè¯çŠ¶æ€
  const session = sessionStore.use(state => state);

  // å¤„ç†ç™»å½•
  const handleLogin = async (credentials) => {
    try {
      const userData = await loginAPI(credentials);
      sessionStore.beats.login(userData);
    } catch (error) {
      console.error('Login failed:', error);
    }
  };

  // å¤„ç†ç™»å‡º
  const handleLogout = () => {
    sessionStore.beats.logout();
  };

  // æ ¹æ®ä¼šè¯çŠ¶æ€æ¸²æŸ“
  if (!session) {
    return <LoginForm onLogin={handleLogin} />;
  }

  return (
    <div>
      <h1>Welcome, {session.user.name}</h1>
      <button onClick={handleLogout}>Logout</button>
    </div>
  );
}

// çŠ¶æ€è®¢é˜…ç¤ºä¾‹
sessionStore.subscribe(
  state => state,
  (newState, prevState) => {
    if (!prevState && newState) {
      console.log('User logged in:', newState.user);
    } else if (prevState && !newState) {
      console.log('User logged out');
    }
  }
);

// ç±»å‹å®‰å…¨ç¤ºä¾‹
function someOperation() {
  const state = sessionStore.snapshot;

  // éœ€è¦è¿›è¡Œ null æ£€æŸ¥
  if (!state) {
    console.log('No active session');
    return;
  }

  // è¿™é‡Œ state çš„ç±»å‹å·²ç»è¢«æ”¶çª„ä¸º SessionState
  console.log(`User ${state.user.name} last active:`, state.lastActive);
}

// é”™è¯¯å¤„ç†ç¤ºä¾‹
sessionStore.setErrorHandler(error => {
  if (error.message.includes('auth')) {
    // å¤„ç†è®¤è¯ç›¸å…³é”™è¯¯
    sessionStore.beats.logout();
    showAuthError(error);
  } else {
    // å¤„ç†å…¶ä»–é”™è¯¯
    console.error('Session error:', error);
  }
});
```

3. å·¥ä½œæµä¸­ä½¿ç”¨:

```typescript
// å¤„ç†ç™»å½•æµç¨‹
async function handleLogin(credentials) {
  try {
    await sessionStore.workflow([
      { loading: true },
      async () => {
        const userData = await loginAPI(credentials);
        return userData; // è¿”å›å®Œæ•´çš„ä¼šè¯çŠ¶æ€
      },
      state => {
        if (!state) throw new Error('Login failed');
        return {
          ...state,
          lastActive: Date.now(),
        };
      },
      { loading: false },
    ]);
  } catch (error) {
    sessionStore.set(null); // ç™»å½•å¤±è´¥æ—¶æ¸…ç©ºçŠ¶æ€
    throw error;
  }
}
```

4. ç±»å‹çº¦æŸè¯´æ˜:

```typescript
// AllowNull ç±»å‹å‚æ•°ä¼šå½±å“ä»¥ä¸‹æ–¹æ³•çš„ç±»å‹å®šä¹‰:

// 1. æ„é€ å‡½æ•°
constructor(
  name: string,
  defaultValue: AllowNull extends null ? T | null : T,
  options?: EchoOptions<T>
);

// 2. snapshot å±æ€§
readonly snapshot: AllowNull extends null ? T | null : T;

// 3. set æ–¹æ³•
set(
  value: AllowNull extends null
    ? Partial<T> | null | ((state: T | null) => Partial<T> | null)
    : Partial<T> | ((state: T) => Partial<T>)
): void;

// 4. è‡ªå®šä¹‰æ–¹æ³•è¿”å›å€¼
methods: {
  [key: string]: AllowNull extends null
    ? (state: T | null) => Partial<T> | null
    : (state: T) => Partial<T>
}
```
