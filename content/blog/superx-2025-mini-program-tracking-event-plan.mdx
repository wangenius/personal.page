---
title: "Brave the World superX 2025 Mini-program Tracking Event Plan"
description: "Mini-program event tracking specifications, metric definitions, and data quality monitoring plan"
date: 2025-04-01
---

**Version:** v1.0
**Date:** April 2025

## 1. General Specifications

**Naming Convention**

- Event Name: `<domain>.<action>[.<object>]`, past tense verbs (e.g., `auth.login.success`).
- Properties: Snake case (`snake_case`), use `*_id` for business primary keys.
- Timestamp: Unified UTC, align with `ts` field upon database insertion.
- User Identifier: Client reports `openid`, server maps it to `user_id` (UUID) upon insertion.

**Global Context Fields (Mandatory for all events)**

| Field       | Type        | Description                               |
| ----------- | ----------- | ----------------------------------------- |
| user_id     | UUID/null   | Nullable if not logged in                 |
| openid      | string/null | Nullable before first login               |
| session_id  | string      | Session identifier (from launch to cold start) |
| device_id   | string      | Device fingerprint                        |
| os          | string      | iOS/Android/Devtools                      |
| app_version | string      | Mini-program version                      |
| network     | string      | wifi/4g/5g                                |
| region      | string      | Parsed from system or user profile        |
| campaign_id | UUID/null   | Associated activity, nullable             |
| trace_id    | string      | End-to-end link tracing                   |
| ts          | datetime    | Sampling timestamp (UTC)                  |

**Compliance Requirements**

- Do not collect highly sensitive data like precise location and contacts; all IDs must be hashed/desensitized on the server; retention period follows contract and regulations (suggestion: 180 days for behavioral details, 24 months for aggregated data).
- Anti-fraud features (like IP, UA summary) are only for risk control and will not be exported at the individual level.

---

## 2. Event List and Property Dictionary (Core)

> The following is the **Minimum Viable Product (MVP)**. It can be extended based on activity mechanics.

### 2.1 Authentication / Launch

1.  `auth.login.request`
    -   Trigger: Before calling `/auth/wx-login`
    -   Properties: `source`(string: code/iv/encrypted), `retries`(int)

2.  `auth.login.success`
    -   Properties: `user_id`(UUID), `has_unionid`(bool), `first_login`(bool)

3.  `app.launch`
    -   Properties: `entry`(string: scene/qrcode/share), `scene`(int), `cold_start`(bool)

### 2.2 Campaign Exposure and Entry

1.  `campaign.impression`
    -   Properties: `campaign_id`(UUID), `position`(string: banner/list/landing), `rank`(int)

2.  `campaign.enter`
    -   Properties: `campaign_id`, `stage_id`(UUID/null), `source`(string: share/deeplink/qr)

### 2.3 Tasks & Points

1.  `task.list.view`
    -   Properties: `campaign_id`, `available_cnt`(int)

2.  `task.complete.submit`
    -   Properties: `task_id`(UUID), `task_type`(enum: daily/oneoff/milestone/store_redeem/share)

3.  `task.complete.result`
    -   Properties: `task_id`, `success`(bool), `points_delta`(int), `ledger_id`(UUID/null), `reason`(string/null)

4.  `points.balance.view`
    -   Properties: `balance`(int)

### 2.4 Lottery & Prize Pool

1.  `draw.trigger`
    -   Properties: `campaign_id`, `mechanic_id`(UUID), `pool_id`(UUID)

2.  `draw.result`
    -   Properties: `campaign_id`, `mechanic_id`, `pool_id`, `won`(bool), `reward_id`(UUID/null), `reward_kind`(enum), `issue_id`(UUID/null), `risk_blocked`(bool), `risk_code`(string/null)

3.  `reward.inventory.snapshot` (Server-side scheduled task)
    -   Properties: `pool_id`, `reward_id`, `inventory`(int), `remaining`(int)

### 2.5 Leaderboard

1.  `leaderboard.view`
    -   Properties: `leaderboard_id`(UUID), `scope`(enum: global/region/store), `my_rank`(int/null), `my_score`(float/null)

### 2.6 Coupons & Redemption (In-store)

1.  `coupon.list.view`
    -   Properties: `count`(int), `unused`(int), `expired`(int)

2.  `coupon.redeem.scan`
    -   Properties: `code_hash`(string), `store_id`(UUID/null), `mode`(string: online/offline)

3.  `coupon.redeem.result`
    -   Properties: `coupon_id`(UUID/null), `success`(bool), `store_id`, `reason`(string/null)

### 2.7 Message Subscription

1.  `msg.subscribe.grant`
    -   Properties: `templates`(string[])

2.  `msg.push.deliver` (Server-side receipt)
    -   Properties: `template_id`(string), `deliver_status`(enum: success/fail/limited), `reason`(string/null)

### 2.8 Performance & Errors (Key Experience)

1.  `perf.page_tti`
    -   Properties: `page`(string), `tti_ms`(int), `fmp_ms`(int/null)

2.  `error.app`
    -   Properties: `code`(string), `message`(string), `stack_hash`(string), `fatal`(bool)

---

## 3. Property Type Specifications (Excerpts)

-   `*_id`: UUID; `code_hash`: SHA256 hash of the coupon code (irreversible).
-   `reason`: Short codes instead of long text (e.g., `DUPLICATE`/`EXPIRED`/`RISK_DENY`/`RATE_LIMIT`).
-   `task_type`, `reward_kind`, `scope` should be consistent with DDL enums.
-   Amounts/points are always integers; units are defined in the business dictionary.

---

## 4. Funnels and Metric Definitions

### 4.1 New User Activation Funnel (D0)

**Path**: `app.launch` → `auth.login.success` → `campaign.impression` → `campaign.enter` → `task.complete.result(success)`

-   **Activation**: (Number of users with `task.complete.result(success=true)` for the first time within D0) / (Number of unique users from `auth.login.success`)
-   **Login Conversion Rate**: `auth.login.success` / `app.launch`
-   **Entry Rate**: `campaign.enter` / `campaign.impression` (Can be by user or by event, user-based by default)

### 4.2 Lottery Conversion Funnel

`draw.trigger` → `draw.result(won=TRUE)`

-   **Lottery Participation Rate**: (Number of participating users) / (Number of users from `campaign.enter`)
-   **Win Rate (Impression-based)**: (Number of `won=TRUE` events) / (Number of `draw.trigger` events)
-   **Draws per Capita**: (Number of `draw.trigger` events) / (Number of participating users)

### 4.3 Coupon Redemption Funnel

`coupon.list.view` → `coupon.redeem.scan` → `coupon.redeem.result(success)`

-   **Redemption Rate (Coupon-based)**: (Number of successfully redeemed coupons) / (Number of issued coupons)
-   **Redemption Conversion (User-based)**: (Number of users who successfully redeemed) / (Number of users holding coupons)

### 4.4 Retention (D1/D7/D30)

-   **Definition**: A user has any active event (`app.launch | campaign.enter | task.complete.result | draw.trigger | coupon.redeem.result`) on the base day and again has any active event on day N.
-   **Deduplication Dimension**: `user_id`.
-   **Churned User**: A user with no active events within N days after the base day is considered churned.

### 4.5 Activity KPIs (Suggestions)

-   **DAU/WAU/MAU**, **Average Session Duration** (supported by an extended `page.view` event, requires adding `page.view` if included).
-   **Task Completion Rate**: (Number of users who completed tasks) / (Number of users exposed to available tasks).
-   **Reward Issuance Accuracy**: `reward_issues(status=issued)` / (Number of win records).
-   **Inventory Health**: `remaining / inventory`, alert threshold: <10%.

---

## 5. Anti-Fraud Signals and Detection (Data-side)

**Signal Collection (With events or server-generated)**

-   `risk_fingerprint` (device/environment summary), `ip_cidr` (/24), `ua_hash`, `velocity_10m` (event frequency in 10 mins), `dup_device_ratio` (ratio of multiple accounts on the same device), `geo_mismatch` (sudden region change).

**Detection Rules (Mark as high-risk if any one is met)**

-   `velocity_10m` > threshold (e.g., ≥ 50 interactions).
-   Unique `user_id`s triggering `draw.trigger` from the same device/IP within 5 minutes ≥ threshold (e.g., ≥ 5).
-   ≥ N cross-region redemption attempts within 1 hour of winning (suspected reselling).

**Response Strategy**

-   De-weighting (lottery weight to zero), CAPTCHA/secondary verification, 24h blacklist, data labeling `risk_flag=true` (retain evidence but exclude from KPIs).

---

## 6. Metric Calculation and Aggregation (Align with DDL)

**Real-time Layer (T+0, minute-level)**

-   Stream-write to `events_raw` (or side-channel to ClickHouse).
-   Produce real-time dashboards: online users, QPS, lottery hits/misses, inventory remaining.

**Offline Layer (T+1, daily granularity)**

-   Task: Generate `events_agg_daily(day, event_key, campaign_id, cnt)`.
-   Metric Calculation (Example SQL):

```sql
-- Win Rate (Event-based)
SELECT day,
       SUM(CASE WHEN properties->>'won' = 'true' THEN 1 ELSE 0 END)::float /
       NULLIF(SUM(1),0) AS win_rate
FROM events_raw
WHERE event_key = 'draw.result'
  AND ts >= :start AND ts < :end
GROUP BY day;
```

---

## 7. Data Quality (DQ) and Monitoring

-   **Completeness**: Alert if daily `cnt` for any event deviates by > ±40% from the 7-day median.
-   **Uniqueness**: Monitor `trace_id + event_key` deduplication ratio (alert if abnormal duplicate reports > 5%).
-   **Timeliness**: Alert if T+1 job latency > 30 minutes.
-   **Validity Check**: Key fields must not be null (`campaign_id`, `task_id`, `reward_id` in their respective events); invalid values are sent to a dead-letter queue for reprocessing.

---

## 8. Dashboard and Alerting Suggestions (Ops/SRE/Operations)

**Operations Dashboard (Daily)**: DAU, entry rate, task completion rate, lottery participation/win rate, inventory health, redemption rate, D1/D7 retention.
**Technical Dashboard (Real-time)**: API success rate, P95 latency, inventory deduction failure rate, risk control rejection rate, error distribution.
**Alert Thresholds (Examples)**

-   `draw.result` failure rate > 3% (in 5 mins) → P1
-   `reward.remaining` < 10% and campaign not over → P2
-   `error.app(fatal)` > 200 occurrences/5 mins → P1

---

## 9. Reporting Implementation Details (Client/Server)

-   **Client SDK**: Encapsulate `track(event_key, props)`; queue failures locally and batch-resend on network recovery; strict rate limiting.
-   **Server-side Validation**: Whitelist event set + JSON Schema validation (versioned by `event_key`); unified write to `events_raw`.
-   **Privacy**: All raw IDs are mapped/hashed on the server before database insertion; avoid plaintext user identifiers in share links.

---

## 10. Event-to-Table Mapping (Key)

| Event                   | Destination                       | Notes                          |
| ----------------------- | --------------------------------- | ------------------------------ |
| `auth.*` / `app.launch` | `events_raw` partition            | Launch and login baseline      |
| `campaign.*` / `task.*` | `events_raw` → `events_agg_daily` | Main funnel                    |
| `draw.*` / `reward.*`   | `events_raw` → Real-time metrics  | Inventory/Wins                 |
| `leaderboard.*`         | `events_raw`                      | For post-analysis              |
| `coupon.*`              | `events_raw`                      | Redemption funnel              |
| `perf.*` / `error.*`    | `events_raw`                      | Quality and stability          |

---

## 11. Appendix: Example JSON (`draw.result`)

```json
{
  "event_key": "draw.result",
  "user_id": "1c1b2d3e-4f5a-678b-9c0d-ef1234567890",
  "campaign_id": "7f2a1b2c-3d4e-5f60-9a01-b2c3d4e5f6a7",
  "trace_id": "trc_9e8d…",
  "properties": {
    "mechanic_id": "a1b2c3…",
    "pool_id": "p_001",
    "won": true,
    "reward_id": "r_009",
    "reward_kind": "coupon",
    "issue_id": "is_77",
    "risk_blocked": false,
    "risk_code": null
  },
  "device": { "os": "iOS", "app_version": "2.5.0" },
  "ts": "2025-04-16T08:15:30Z"
}
```
