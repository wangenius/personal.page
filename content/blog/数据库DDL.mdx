---
title: "数据库 DDL"
description: "勇闯天涯 superX 2025 小程序数据库设计方案"
date: 2025-04-01
---

**编制日期：2025年4月**。生产可按模块分批迁移；包含**类型/表/索引/约束/分区**与少量**RLS/审计**示例。

> 说明：使用 `gen_random_uuid()`（需 `pgcrypto`），时区统一为 `UTC`；金额/积分为整数（最小货币单位/点）。

------

```sql
-- =========================================================
-- superX 2025 - PostgreSQL DDL (v1.0, 2025-04)
-- =========================================================
CREATE EXTENSION IF NOT EXISTS pgcrypto;
CREATE SCHEMA IF NOT EXISTS superx;
CREATE SCHEMA IF NOT EXISTS audit;

SET search_path TO superx, public;

-- =========================
-- 1) 枚举与公共类型
-- =========================
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'campaign_status') THEN
    CREATE TYPE campaign_status AS ENUM ('draft','active','paused','archived');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'task_type') THEN
    CREATE TYPE task_type AS ENUM ('daily','oneoff','milestone','store_redeem','share');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'task_status') THEN
    CREATE TYPE task_status AS ENUM ('available','completed','locked');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'reward_kind') THEN
    CREATE TYPE reward_kind AS ENUM ('physical','coupon','points','qualification');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'ledger_direction') THEN
    CREATE TYPE ledger_direction AS ENUM ('credit','debit','hold','release');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'coupon_status') THEN
    CREATE TYPE coupon_status AS ENUM ('unused','used','expired','locked');
  END IF;
END$$;

-- =========================
-- 2) 用户 & 账号
-- =========================
CREATE TABLE IF NOT EXISTS users (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  openid           TEXT NOT NULL UNIQUE,
  unionid          TEXT,
  nickname         TEXT,
  avatar           TEXT,
  region           TEXT,
  device_fingerprint TEXT,
  risk_tags        TEXT[] DEFAULT '{}',
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_users_unionid ON users(unionid);
CREATE INDEX IF NOT EXISTS idx_users_region ON users(region);

-- =========================
-- 3) 活动域：活动/阶段/机制 配置版控
-- =========================
CREATE TABLE IF NOT EXISTS campaigns (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name          TEXT NOT NULL,
  status        campaign_status NOT NULL DEFAULT 'draft',
  start_at      TIMESTAMPTZ NOT NULL,
  end_at        TIMESTAMPTZ NOT NULL,
  config        JSONB NOT NULL DEFAULT '{}'::jsonb,   -- 活动级配置
  version       INTEGER NOT NULL DEFAULT 1,           -- 版本化
  created_by    UUID,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  CHECK (end_at > start_at)
);
CREATE INDEX IF NOT EXISTS idx_campaigns_status ON campaigns(status);
CREATE INDEX IF NOT EXISTS idx_campaigns_window ON campaigns(start_at, end_at);

CREATE TABLE IF NOT EXISTS stages (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id   UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
  name          TEXT NOT NULL,
  sort_order    INTEGER NOT NULL DEFAULT 100,         -- 排序
  config        JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_stages_campaign ON stages(campaign_id);

-- 机制：任务/抽奖/榜单/UGC/打卡等
CREATE TABLE IF NOT EXISTS mechanics (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  stage_id      UUID NOT NULL REFERENCES stages(id) ON DELETE CASCADE,
  type          TEXT NOT NULL CHECK (type IN ('task','draw','leaderboard','ugc','checkin')),
  name          TEXT NOT NULL,
  config        JSONB NOT NULL DEFAULT '{}'::jsonb,   -- 机制级配置
  enabled       BOOLEAN NOT NULL DEFAULT TRUE,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_mechanics_stage ON mechanics(stage_id);
CREATE INDEX IF NOT EXISTS idx_mechanics_type ON mechanics(type);

-- =========================
-- 4) 任务 & 积分账本
-- =========================
CREATE TABLE IF NOT EXISTS tasks (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mechanic_id   UUID NOT NULL REFERENCES mechanics(id) ON DELETE CASCADE,
  title         TEXT NOT NULL,
  type          task_type NOT NULL,
  points        INTEGER NOT NULL DEFAULT 0 CHECK (points >= 0),
  config        JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_tasks_mechanic ON tasks(mechanic_id);
CREATE INDEX IF NOT EXISTS idx_tasks_type ON tasks(type);

-- 用户完成记录（幂等）
CREATE TABLE IF NOT EXISTS task_records (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id       UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  status        task_status NOT NULL DEFAULT 'completed',
  idempotency_key TEXT, -- (user+task+payload) 的请求幂等键
  payload       JSONB,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (task_id, user_id),
  UNIQUE (user_id, idempotency_key)
);
CREATE INDEX IF NOT EXISTS idx_task_records_user ON task_records(user_id);

-- 积分账本
CREATE TABLE IF NOT EXISTS point_ledger (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  amount        INTEGER NOT NULL, -- 正负均可；正=入账，负=扣减；hold/release仅记录状态不改变余额
  direction     ledger_direction NOT NULL,
  ref_type      TEXT,               -- 关联类型：task/draw/redeem/rollback等
  ref_id        TEXT,
  status        TEXT NOT NULL DEFAULT 'confirmed' CHECK (status IN ('pending','confirmed','failed')),
  trace_id      TEXT,               -- 链路追踪
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
) PARTITION BY RANGE (created_at);

-- 月分区（示例，生产中可自动创建）
CREATE TABLE IF NOT EXISTS point_ledger_2025_04 PARTITION OF point_ledger
  FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');
CREATE INDEX IF NOT EXISTS idx_point_ledger_user_time_2025_04 ON point_ledger_2025_04(user_id, created_at);
CREATE INDEX IF NOT EXISTS idx_point_ledger_ref_2025_04 ON point_ledger_2025_04(ref_type, ref_id);

-- 用户积分余额（派生表/物化视图二选一，选表+触发器更直接）
CREATE TABLE IF NOT EXISTS point_balance (
  user_id   UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
  balance   BIGINT NOT NULL DEFAULT 0,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_point_balance_positive ON point_balance((balance > 0));

-- =========================
-- 5) 奖池/库存/发放（抽奖）
-- =========================
CREATE TABLE IF NOT EXISTS reward_pools (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id   UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
  title         TEXT NOT NULL,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_reward_pools_campaign ON reward_pools(campaign_id);

CREATE TABLE IF NOT EXISTS rewards (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  pool_id       UUID NOT NULL REFERENCES reward_pools(id) ON DELETE CASCADE,
  kind          reward_kind NOT NULL,
  title         TEXT NOT NULL,
  inventory     INTEGER NOT NULL DEFAULT 0 CHECK (inventory >= 0),
  remaining     INTEGER NOT NULL DEFAULT 0 CHECK (remaining >= 0),
  metadata      JSONB NOT NULL DEFAULT '{}'::jsonb,
  weight        NUMERIC(10,4) NOT NULL DEFAULT 0, -- 抽奖权重
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  CHECK (remaining <= inventory)
);
CREATE INDEX IF NOT EXISTS idx_rewards_pool ON rewards(pool_id);
CREATE INDEX IF NOT EXISTS idx_rewards_kind ON rewards(kind);

-- 发放记录（抽中或发券）
CREATE TABLE IF NOT EXISTS reward_issues (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  reward_id     UUID NOT NULL REFERENCES rewards(id) ON DELETE RESTRICT,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  status        TEXT NOT NULL DEFAULT 'issued' CHECK (status IN ('issued','failed','revoked')),
  trace_id      TEXT,
  idempotency_key TEXT,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id, idempotency_key)
);
CREATE INDEX IF NOT EXISTS idx_reward_issues_user ON reward_issues(user_id);

-- =========================
-- 6) 排行榜（实时/快照）
-- =========================
CREATE TABLE IF NOT EXISTS leaderboards (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id   UUID NOT NULL REFERENCES campaigns(id) ON DELETE CASCADE,
  key           TEXT NOT NULL,             -- 榜单唯一 key
  scope         TEXT NOT NULL DEFAULT 'global', -- global/region/store
  weights       JSONB NOT NULL DEFAULT '{}'::jsonb, -- 指标权重
  config        JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (campaign_id, key)
);

CREATE TABLE IF NOT EXISTS leaderboard_entries (
  leaderboard_id UUID NOT NULL REFERENCES leaderboards(id) ON DELETE CASCADE,
  user_id        UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  score          NUMERIC(18,6) NOT NULL DEFAULT 0,
  rank           BIGINT,
  ext            JSONB NOT NULL DEFAULT '{}'::jsonb,
  updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (leaderboard_id, user_id)
);
CREATE INDEX IF NOT EXISTS idx_lb_entries_rank ON leaderboard_entries(leaderboard_id, rank);
CREATE INDEX IF NOT EXISTS idx_lb_entries_score ON leaderboard_entries(leaderboard_id, score DESC);

-- =========================
-- 7) 券与核销（门店联动）
-- =========================
CREATE TABLE IF NOT EXISTS stores (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  code          TEXT UNIQUE,   -- 第三方/线下系统门店码
  name          TEXT NOT NULL,
  region        TEXT,
  metadata      JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS coupons (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  code          TEXT UNIQUE NOT NULL,
  status        coupon_status NOT NULL DEFAULT 'unused',
  expires_at    TIMESTAMPTZ,
  metadata      JSONB NOT NULL DEFAULT '{}'::jsonb,
  locked_by     UUID, -- 核销时短暂锁定
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_coupons_user ON coupons(user_id);
CREATE INDEX IF NOT EXISTS idx_coupons_exp ON coupons(expires_at);

CREATE TABLE IF NOT EXISTS redemptions (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coupon_id     UUID NOT NULL REFERENCES coupons(id) ON DELETE CASCADE,
  store_id      UUID REFERENCES stores(id) ON DELETE SET NULL,
  redeemed_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  trace_id      TEXT,
  UNIQUE (coupon_id)
);
CREATE INDEX IF NOT EXISTS idx_redemptions_store ON redemptions(store_id);

-- =========================
-- 8) 消息授权/订阅
-- =========================
CREATE TABLE IF NOT EXISTS message_subscriptions (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  template_ids  TEXT[] NOT NULL,
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (user_id)
);

-- =========================
-- 9) A/B 实验
-- =========================
CREATE TABLE IF NOT EXISTS ab_experiments (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name          TEXT NOT NULL UNIQUE,
  metric_keys   TEXT[] NOT NULL DEFAULT '{}',
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);

CREATE TABLE IF NOT EXISTS ab_buckets (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  experiment_id UUID NOT NULL REFERENCES ab_experiments(id) ON DELETE CASCADE,
  key           TEXT NOT NULL,
  weight        NUMERIC(6,3) NOT NULL CHECK (weight >= 0),
  UNIQUE (experiment_id, key)
);

CREATE TABLE IF NOT EXISTS ab_assignments (
  experiment_id UUID NOT NULL REFERENCES ab_experiments(id) ON DELETE CASCADE,
  user_id       UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  bucket_key    TEXT NOT NULL,
  assigned_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
  PRIMARY KEY (experiment_id, user_id)
);

-- =========================
-- 10) 事件/埋点（明细分区 + 聚合）
-- =========================
CREATE TABLE IF NOT EXISTS events_raw (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id       UUID REFERENCES users(id) ON DELETE SET NULL,
  event_key     TEXT NOT NULL,
  campaign_id   UUID,
  properties    JSONB NOT NULL DEFAULT '{}'::jsonb,
  device        JSONB NOT NULL DEFAULT '{}'::jsonb,
  ts            TIMESTAMPTZ NOT NULL
) PARTITION BY RANGE (ts);

-- 示例分区：2025-04
CREATE TABLE IF NOT EXISTS events_raw_2025_04 PARTITION OF events_raw
  FOR VALUES FROM ('2025-04-01') TO ('2025-05-01');
CREATE INDEX IF NOT EXISTS idx_events_2025_04_key_ts ON events_raw_2025_04(event_key, ts);
CREATE INDEX IF NOT EXISTS idx_events_2025_04_user_ts ON events_raw_2025_04(user_id, ts);

-- 聚合表（可由离线/流式管道写入）
CREATE TABLE IF NOT EXISTS events_agg_daily (
  day           DATE NOT NULL,
  event_key     TEXT NOT NULL,
  campaign_id   UUID,
  cnt           BIGINT NOT NULL,
  PRIMARY KEY (day, event_key, campaign_id)
);

-- =========================
-- 11) 配置与审计
-- =========================
CREATE TABLE IF NOT EXISTS config_versions (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  scope         TEXT NOT NULL,         -- e.g. 'campaign','mechanic','task','feature_flag'
  ref_id        UUID NOT NULL,
  version       INTEGER NOT NULL,
  config        JSONB NOT NULL,
  created_by    UUID,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE (scope, ref_id, version)
);

-- 操作审计表（应用侧写入）
CREATE TABLE IF NOT EXISTS audit_logs (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  actor_id      UUID,
  action        TEXT NOT NULL,         -- CREATE/UPDATE/DELETE/VERIFY/ISSUE 等
  entity        TEXT NOT NULL,
  entity_id     TEXT NOT NULL,
  detail        JSONB NOT NULL DEFAULT '{}'::jsonb,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX IF NOT EXISTS idx_audit_entity ON audit_logs(entity, entity_id, created_at DESC);

-- =========================
-- 12) 关键索引与约束（补充）
-- =========================
-- 防止券过期后核销：由业务/触发器控制；这里加 CHECK 仅对已有值生效
ALTER TABLE redemptions
  ADD CONSTRAINT redemptions_coupon_not_null CHECK (coupon_id IS NOT NULL);

-- 奖池剩余量不为负（再次加固，业务层已控制）
ALTER TABLE rewards
  ADD CONSTRAINT rewards_remaining_nonneg CHECK (remaining >= 0);

-- =========================
-- 13) RLS（示例，按需开启）
-- =========================
-- 仅示例：对 point_ledger 开启基于会话变量的 RLS
-- SELECT set_config('app.current_user_id', '<uuid>', true) 由应用层注入
ALTER TABLE point_ledger ENABLE ROW LEVEL SECURITY;
CREATE POLICY pl_self_read ON point_ledger
  FOR SELECT USING (user_id::text = current_setting('app.current_user_id', true));
CREATE POLICY pl_self_insert ON point_ledger
  FOR INSERT WITH CHECK (user_id::text = current_setting('app.current_user_id', true));

-- =========================
-- 14) 物化视图（可选）：积分 TopN 快照
-- =========================
CREATE MATERIALIZED VIEW IF NOT EXISTS mv_point_topn AS
SELECT user_id, balance, updated_at
FROM point_balance
ORDER BY balance DESC
LIMIT 1000 WITH NO DATA;

-- =========================
-- 15) 注释（文档化）
-- =========================
COMMENT ON TABLE campaigns IS '活动主表（版本化配置 + 时间窗 + 状态）';
COMMENT ON COLUMN campaigns.config IS '活动层配置 JSON，搭配 config_versions 做回滚';
COMMENT ON TABLE point_ledger IS '积分账本（分区表），记录入账/扣减/冻结等明细';
COMMENT ON TABLE rewards IS '奖品定义与库存；remaining 需与发放事务一致';

-- =========================
-- 16) 建议触发器（伪代码占位，实际请在应用层实现事务）
-- =========================
-- 1) 发放奖励时：rewards.remaining -= 1（检查剩余 >= 1），插入 reward_issues
-- 2) 写入 point_ledger 后：同步 upsert 到 point_balance（balance += amount）
-- 3) coupons 状态流转：locked -> used（插入 redemptions），超时回滚为 unused
```

------

## 交付说明与落地要点

- **分区策略**：`point_ledger` 与 `events_raw` 按月分区；高峰期可周分区。自动建分区任务放到运维计划。
- **一致性**：抽奖/发放/扣减请放入**同一事务**；`remaining` 与 `reward_issues` 强一致。
- **幂等**：对写入路径（任务完成、抽奖、发放、核销）使用 `idempotency_key` 唯一约束。
- **读写分离**：报表查询走只读副本；`events_raw` 大量写入与明细查询走 ClickHouse 亦可（表结构对齐）。
- **RLS**：示例仅演示，后台运营（JWT+RBAC）建议以视图 + 安全函数隔离数据域（区域/门店）。
- **迁移顺序**：基础表（users → campaigns/stages/mechanics）→ 任务/积分 → 奖池/发放 → 券/核销 → 榜单 → 事件/聚合 → 审计/配置 → RLS 与物化视图。